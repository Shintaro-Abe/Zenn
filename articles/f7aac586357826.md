---
title: "VPCフローログを覗いてみよう"
emoji: "🏄🏾‍♂️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["AWS"]
published: false
---

# 構成図

![flowlogs](https://github.com/Shintaro-Abe/Zenn/blob/1343aa7c084741cc2a888d894017f9c27b205ae7/articles/flowlogs.drawio.png)

__セキュリティーグループ__

| ルール| プロトコル| ポート| ソース|
| :---: | :---: | :---: | :---: |
| インバウンド|HTTP|80|Anywhere IPv4|
| アウトバウンド| すべてのトラフィック | すべて|Anywhere IPv4|

__EC2__

|プライベートIPアドレス| ネットワークインターフェイス|
| :---: | :---: |
| 10.0.10.30| eni-0322957cfa6bc9585|

# フローログレコード

__取得フィールド__

デフォルトのフィールドで設定。

```
${version} ${account-id} ${interface-id} ${srcaddr} ${dstaddr} ${srcport} ${dstport} ${protocol}
 ${packets} ${bytes} ${pkt-srcaddr} ${pkt-src-aws-service} ${pkt-dstaddr} ${pkt-dst-aws-service} 
${start} ${end} ${log-status}
```

| フィールド| 意味|
| :--- | :--- | 
| accountId| ソースネットワークインターフェースの所有者のアカウント。|
| action | ACCEPT：許可された通信。<br> REJECT ：拒否された通信。|
| bytes | 転送されたバイト数。|
| dstAddr | 送信先のIPアドレス。|
| dstPort |送信先のポート。|
| end | 最後のパケットが受信された時間(UNIX秒)。<br>UNIX秒： 協定世界時1970年1月1日午前0時からの経過秒数。[UNIX秒計算サイト](https://keisan.casio.jp/exec/system/1526004418)|
| interfaceId | 通信の記録がされるネットワークインターフェース。|
| logStatus | ログの状態。<br>OK：正常に記録<br>NODATA：ネットワークインターフェイスとの通信なし。<br> SKIPDATA ： キャパシティー制限やエラーの原因により記録がスキップされた。|
| packets | 転送されたパケットの数。<br>パケット： 転送する際に、特定の長さで細かく分割したデータ。送信先で組み合わせる。|
| protocol |トラフィックの IANA プロトコル番号。|
| srcAddr | 送信元のIPアドレス。|
| srcPort | 送信元のポート。|
| start | 最初のパケットが受信された時間(UNIX秒)。|
| version | フローログのバージョン。 デフォルトは2。|

## セキュリティーグループのインバウンドルールを全て削除

* 自宅PC(xxx.xxx.xxx.xxx)からのリクエストは拒否。
リクエストの段階で拒否されているため、レスポンスは発生せず。

__ログ出力__

```
2023-02-14T05:30:47.000+09:00
2 417338593075 eni-0322957cfa6bc9585 xxx.xxx.xxx.xxx 10.0.10.30 50611 80 6 11 688 1676320247 1676320367 REJECT OK
```
__フロー__

IPアドレス **xxx.xxx.xxx.xxx** のポート **50611** 番から、ネットワークインターフェイス **eni-0322957cfa6bc9585** のIPアドレス **10.0.10.30** のポート **80** 番あてに **HTTP** 通信あり、セキュリティグループの設定によりアクセス **拒否** 。
この通信は **2023年02月14日05:30:47** に受信開始 **2023年02月14日05:32:47** に受信終了。 **588バイト** 、 **11パケット** の通信。

| Version| accountId| interfaceId| srcAddr | dstAddr| srcPort| dstPort| protocol | packets | bytes| start| end | action| logStatus|
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
|2 |417338593075| eni-0322957cfa6bc9585| xxx.xxx.xxx.xxx| 10.0.10.30| 50611| 80| 6 (HTTP)| 11| 688 |1676320247 |1676320367 |REJECT| OK|

---

* セキュリティグループがステートフルのため、EC2から発信されたUDP通信はレスポンスも許可。

__ログ出力__

```
2023-02-14T05:30:47.000+09:00
2 417338593075 eni-0322957cfa6bc9585 82.209.245.153 10.0.10.30 123 35612 17 1 76 1676320247 1676320307 ACCEPT OK

2023-02-14T05:30:47.000+09:00
2 417338593075 eni-0322957cfa6bc9585 10.0.10.30 82.209.245.153 35612 123 17 1 76 1676320247 1676320307 ACCEPT OK
```
__フロー__

ネットワークインターフェイス **eni-0322957cfa6bc9585** のIPアドレス **10.0.10.30** のポート **35612** 番から、IPアドレス **82.209.245.153** のポート **123** 番あてにリクエストの **UDP** 通信あり、セキュリティグループの設定により発信を **許可** 。
この通信は **2023年02月14日05:30:47** に受信開始 **2023年02月14日05:31:47** に受信終了。 **76バイト** 、 **1パケット** の通信。

IPアドレス **82.209.245.153** のポート **123** 番から、ネットワークインターフェイス **eni-0322957cfa6bc9585** のIPアドレス **10.0.10.30** のポート **35612** 番あてにレスポンスの **UDP** 通信あり、セキュリティグループの設定によりアクセス **許可** 。
この通信は **2023年02月14日05:30:47** に受信開始 **2023年02月14日05:31:47** に受信終了。 **76バイト** 、 **1パケット** の通信。

| Version| accountId| interfaceId| srcAddr | dstAddr| srcPort| dstPort| protocol | packets | bytes| start| end | action| logStatus|
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| 2| 417338593075| eni-0322957cfa6bc9585 |10.0.10.30| 82.209.245.153| 35612| 123| 17 (UDP)| 1| 76| 1676320247 |1676320307| ACCEPT| OK|
|2| 417338593075| eni-0322957cfa6bc9585 |82.209.245.153| 10.0.10.30| 123| 35612 |17 |1| 76 |1676320247 |1676320307| ACCEPT| OK|

---
## インバウンドルールにHTTP(80,AnywhereIPv4)を追加

* 自宅PCからのリクエストにWEBサーバーがレスポンスを発信。

__ログ出力__

```
2023-02-14T05:41:01.000+09:00
2 417338593075 eni-0322957cfa6bc9585 xxx.xxx.xxx.xxx 10.0.10.30 49203 80 6 9 1171 1676320861 1676320908 ACCEPT OK

2023-02-14T05:41:01.000+09:00
2 417338593075 eni-0322957cfa6bc9585 10.0.10.30 xxx.xxx.xxx.xxx 80 49203 6 9 5423 1676320861 1676320908 ACCEPT OK
```
__フロー__

IPアドレス **xxx.xxx.xxx.xxx** のポート **49203** 番から、ネットワークインターフェイス **eni-0322957cfa6bc9585** のIPアドレス **10.0.10.30** のポート **80** 番あてにリクエストの **HTTP** 通信あり、セキュリティグループの設定によりアクセス **許可** 。
この通信は **2023年02月14日05:41:01** に受信開始 **2023年02月14日05:41:48** に受信終了。 **1171バイト** 、 **9パケット** の通信。

ネットワークインターフェイス **eni-0322957cfa6bc9585** のIPアドレス **10.0.10.30** のポート **80** 番から、IPアドレス **xxx.xxx.xxx.xxx** のポート **49203** 番あてにレスポンスの **HTTP** 通信あり、セキュリティグループの設定により発信を **許可** 。
この通信は **2023年02月14日05:41:01** に受信開始 **2023年02月14日05:41:48** に受信終了。 **5423バイト** 、 **9パケット** の通信。

| Version| accountId| interfaceId| srcAddr | dstAddr| srcPort| dstPort| protocol | packets | bytes| start| end | action| logStatus|
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| 2 |417338593075 |eni-0322957cfa6bc9585 |xxx.xxx.xxx.xxx| 10.0.10.30| 49203 |80| 6| 9| 1171| 1676320861| 1676320908 |ACCEPT| OK|
|2| 417338593075| eni-0322957cfa6bc9585 |10.0.10.30 |xxx.xxx.xxx.xxx |80 |49203| 6| 9| 5423 |1676320861| 1676320908 |ACCEPT| OK|

---
## ACLのインバウンドルールを全て拒否

* 自宅PCからのリクエストは拒否。
* EC2からの通信はセキュリティグループのアウトバウンドが発信を許可しているが、レスポンスはACLがアクセス拒否。
セキュリティーグループがステートフルでも通信が到達しないため受信不可。

__ログ出力__

```
2023-02-14T05:51:48.000+09:00
2 417338593075 eni-0322957cfa6bc9585 162.159.200.123 10.0.10.30 123 50392 17 1 76 1676321508 1676321568 REJECT OK

2023-02-14T05:51:48.000+09:00
2 417338593075 eni-0322957cfa6bc9585 10.0.10.30 162.159.200.123 50392 123 17 1 76 1676321508 1676321568 ACCEPT OK
```
__フロー__

ネットワークインターフェイス **eni-0322957cfa6bc9585** のIPアドレス **10.0.10.30** のポート **50392** 番から、IPアドレス **162.159.200.123** のポート **123** 番あてにリクエストの **UDP** 通信あり、セキュリティグループの設定により発信を **許可** 。
この通信は **2023年02月14日05:51:48** に受信開始 **2023年02月14日05:52:48** に受信終了。 **76バイト** 、 **1パケット** の通信。

IPアドレス **162.159.200.123** のポート **123** 番から、ネットワークインターフェイス **eni-0322957cfa6bc9585** のIPアドレス **10.0.10.30** のポート **50392** 番あてにレスポンスの **UDP** 通信あり、ACLの設定によりアクセス **拒否** 。
この通信は **2023年02月14日05:51:48** に受信開始 **2023年02月14日05:52:48** に受信終了。 **76バイト** 、 **1パケット** の通信。

| Version| accountId| interfaceId| srcAddr | dstAddr| srcPort| dstPort| protocol | packets | bytes| start| end | action| logStatus|
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
|2 |417338593075| eni-0322957cfa6bc9585| 10.0.10.30 |162.159.200.123 |50392 |123 |17| 1| 76| 1676321508| 1676321568| ACCEPT| OK|
| 2 |417338593075 |eni-0322957cfa6bc9585 |162.159.200.123 |10.0.10.30| 123 |50392 |17 |1 |76| 1676321508| 1676321568 |REJECT |OK|

## ルートテーブルからインターネットゲートウェイをデタッチ

* インターネットゲートウェイをデタッチすると、インスタンスは発信を停止。
ログは外部からインスタンスへの通信のみで、全て拒否。

__ログ出力__

```
2023-02-14T06:01:54.000+09:00
2 417338593075 eni-0322957cfa6bc9585 xxx.xxx.xxx.xxx 10.0.10.30 50859 80 6 9 576 1676322114 1676322169 REJECT OK
```
__フロー__

IPアドレス **27.138.93.252** のポート **50859** 番から、ネットワークインターフェイス **eni-0322957cfa6bc9585** のIPアドレス **10.0.10.30** のポート **80** 番あてに **HTTP** 通信あり、ルートテーブルの設定によりアクセス **拒否** 。
この通信は **2023年02月14日06:01:54** に受信開始 **2023年02月14日06:02:49** に受信終了。 **576バイト** 、 **9パケット** の通信。

| Version| accountId| interfaceId| srcAddr | dstAddr| srcPort| dstPort| protocol | packets | bytes| start| end | action| logStatus|
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
|2 |417338593075| eni-0322957cfa6bc9585| xxx.xxx.xxx.xxx |10.0.10.30 |50859 |80|6| 9| 576| 1676322114| 1676322169| REJECT| OK|
